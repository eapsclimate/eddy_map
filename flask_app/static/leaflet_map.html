
<!DOCTYPE html>
<html>
<head>
	<title>Leaflet Quick Start Guide Example</title>
	<meta charset="utf-8" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
</head>
<body>
	<div id="mapid" style="width: 1200px; height: 800px"></div>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
	<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
	<script src="/static/leaflet.ajax.min.js"></script>
	<script>

		var mymap = L.map('mapid').setView([0, 200], 3);

		L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoicmFiZXJuYXQiLCJhIjoiY2luajV5eW51MHhneXVhbTNhdWEzbmRkaSJ9.EzUhO4SMompzRVWAYZcoFw', {
			maxZoom: 18,
			id: 'mapbox.oceans-white'
			//id: 'mapbox.blue-marble-topo-bathy-jul-bw'
		}).addTo(mymap);

		var eddyLayer = L.geoJson.ajax()
		eddyLayer.addTo(mymap);

		var myStyle = {
		    "color": "#000",
		    "weight": 1,
		    "opacity": 0.65
		};

		var geojsonMarkerOptions = {
		    radius: 4,
		    //fillColor: "#00ddcc",
		    color: "#000",
		    weight: 1,
		    opacity: 1,
				stroke: false,
		    fillOpacity: 0.5
		};

		// use a closure to pass extra arguments
		var eddyClicked = function(eddy_id) {
			return function() {
				console.log('Show eddy details ' + eddy_id)
				eddyUrl = "/eddy/" + eddy_id
				eddyLayer.refresh(eddyUrl,
					{style: myStyle, pointToLayer: eddyEndpointToLayer});
			}
		}

		function eddyEndpointToLayer(feature, latlng) {
			if (feature.properties.name=='start_center') {
			    var color = "#00ddcc";
			} else if (feature.properties.name=='end_center'){  
			    var color = "#dd0080";
			}
			var cm = L.circleMarker(latlng,
			 	$.extend({}, geojsonMarkerOptions, {fillColor: color}))
			if (feature.properties.eddy_id) {
				cm = cm.on("click", eddyClicked(feature.properties.eddy_id))
			}
			return cm
		}

		function onEachFeature(feature, layer) {
		    var out = [];
		    if (feature.properties) {
			    for(key in feature.properties){
				out.push(key+": "+feature.properties[key]);
			}
		    }
		    layer.bindPopup(out.join("<br />"));
		}


		var jsonUrl = "/eddies"

		var geojsonLayer = new L.GeoJSON.AJAX(jsonUrl,
					{style: myStyle, pointToLayer: eddyEndpointToLayer,
					 onEachFeature: onEachFeature});
		geojsonLayer.addTo(mymap);

	</script>
</body>
</html>
